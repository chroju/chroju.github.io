    <!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="the world as code">
		<meta name="description" content="about IT Infrastructure, DevOps, and Hacker philosophy.">
		<meta name="generator" content="Hugo 0.16-DEV" />
		<title>Ruby基礎復習(8) Fileクラス &middot; the world as code</title>
		<link rel="shortcut icon" href="https://chroju.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://chroju.github.io/css/style.css">
		<link rel="stylesheet" href="https://chroju.github.io/css/highlight.css">
		<link rel="stylesheet" href="https://chroju.github.io/css/monosocialiconsfont.css">
		
		<link href="https://chroju.github.io/atom.xml" rel="alternate" type="application/rss+xml" title="the world as code" />
		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://chroju.github.io/'> <span class="arrow">←</span>Home</a>
	

	
		<a href='https://chroju.github.io/about'>About</a>
	

	
	<a class="cta" href="https://chroju.github.io/atom.xml">Subscribe</a>
	
</nav>


        <section id="wrapper">
            <article class="post">
                <header>
                    <h1>Ruby基礎復習(8) Fileクラス</h1>
                    <h2 class="headline">April 10, 2015</h2>
                </header>
                <section id="post-body">
                    <p>『パーフェクトRuby』p.196より。わりと苦手な分野。</p>

<p>まずはファイルをひらく。<code>#open</code>して変数に格納してもいいし、ブロックを引き渡して処理させることもできる。後者の場合は処理が終わると自動でクローズしてくれるので、こっちの方が楽っぽい。<code>#read</code>はファイルの内容全体を読み込む一方、<code>#gets</code>を使うと1行ずつ読み込むことができる。あるいは<code>#each_line</code>や<code>#each_char</code>といったメソッドも。</p>

<pre><code class="language-ruby">file = File.open('example.txt')
p file.read # example.txtの内容を表示
file.close

File.open 'example.txt' do |file|
  p file.read
end

File.read('example.txt')

File.open 'example.txt' do |file|
  while line = file.gets
    p line
  end
end

File.open 'example.txt' do |file|
  f.each_line do |line|
    p line
  end
end
</code></pre>

<p>書き込むときは<code>#open</code>の第二引数にファイルを開くモードを指定する。デフォルトは<code>'r'</code>、すなわち読み込みモードで、他は以下の通り。基本は<code>r</code>が読み込み、<code>w</code>が書き込み、<code>a</code>が追記で、<code>+</code>を付けると読み書き両用モードになる。また<code>b</code>を後置するとバイナリモードで開かれる。</p>

<p>| r  | 読み込みモード         |
| r+ | 読み書き両用モード（読み書き位置は先頭から）       |
| w  | 上書き書き込みモード   |
| w+ | 新規作成して読み書き両用モード |
| a  | 追記書き込みモード       |
| a+ | 追記読み書き両用モード（読み込み位置は先頭から、書き込みは追記形式）  |</p>

<pre><code class="language-ruby">File.open 'example.txt', 'w' do |f|
  f.write 'hoge'
end
</code></pre>

<p>もっと単純に<code>#write</code>メソッドだけでも書き込み可能。</p>

<pre><code class="language-ruby">File.write 'example.txt', 'fuga'
</code></pre>

<p>先のファイルを開くモードの話の中で「読み込み位置は先頭から」という表現があったが、IOオブジェクトではファイル内の今どこを読み／書きしているかというアクセス位置が存在する。<code>#gets</code>では1行ずつ読み込みを行ったように、読み／書きを行うことでアクセス位置は進んでいく。先頭まで戻りたい場合は<code>#rewind</code>を使う。また<code>#seek</code>メソッドは第二引数に定数で指定した基準位置より、第一引数の整数分アクセス位置を移動させることができる。<code>#pos</code>は絶対的にアクセス位置を指定して動かせる。</p>

<pre><code class="language-ruby">File.open 'example.txt' do |f|
  f.puts
  f.rewind # 先頭位置まで戻る

  f.seek 10 # 先頭から10進む
  f.seek -10, IO::SEEK_END # 末尾（SEEK_END）から10戻った位置に移動

  f.pos = 25 # 先頭から25バイト目に移動
  f.pos # =&gt; 25
end
</code></pre>

<p>文字のエンコーディングについては、「外部」と「内部」という概念を持つ。外部はファイルのエンコーディング情報であり、内部はRuby上で処理する際のエンコーディング情報。例えばEUC-JPのファイルをutf-8で変換して取り扱い、書き込みはEUC-JPで、といったことができる。エンコーディングの設定には<code>#set_encoding</code>メソッドを使う。引数を1つだけ取る場合は外部エンコーディングを設定し、2つ取る場合は第一引数が外部、第二引数が内部を設定する。あるいは<code>File#open</code>するときに、読み書きモードと一緒にエンコーディングも指定することができる。</p>

<pre><code class="language-ruby">File.open 'example.txt' do |f|
  f.set_encoding('utf-8') # 外部エンコーディングをutf-8に設定

  f.set_encoding('utf-8', 'EUC-JP') # 外部エンコーディングをutf-8、内部エンコーディングをEUC-JPに設定
  f.set_encoding('utf-8:EUC-JP') # 外部エンコーディングをutf-8、内部エンコーディングをEUC-JPに設定
end

File.open 'example.txt', 'r:utf-8:EUC-JP' do |f|
  p f.external_encoding # =&gt; &quot;utf-8&quot;
  p f.internal_encoding # =&gt; &quot;EUC-JP&quot;
end
</code></pre>

<p>ファイルのロックには<code>#flock</code>メソッドを利用する。ロックのモードは<a href="http://docs.ruby-lang.org/ja/1.9.3/method/File/i/flock.html">ここに記載の定数</a>を使って指定するのだが、主に<code>File::LOCK_EX</code>が排他ロックであることを覚えとけばいいような気も。</p>

<pre><code class="language-ruby">File.open 'example.txt', 'w' do |f|
  f.flock File::LOCK_EX
end
</code></pre>

<p>その他、ファイル情報取得系のメソッドをつらつらと。これらはファイルオブジェクトから取得するだけではなく、<code>File.atime(filename)</code>の形で<code>File</code>クラスのクラスメソッドでも呼び出すことができる。</p>

<pre><code class="language-ruby">File.open 'example.txt' do |f|
  f.atime # 最終アクセス日時
  f.ctime # 最終変更日時
  f.mtime # 最終更新日時

  f.size # ファイルサイズ

  f.ftype # ファイルタイプ 以下真偽判定メソッドも有り
  f.file?
  f.directory?
  f.symlink?

  f.writable? # =&gt; false
  f.readable? # =&gt; true
  f.executable? # =&gt; false

  f.owned? # =&gt; false (自身がファイル所有者か？)
  f.gid # ファイル所有者のGID
  f.uid # ファイル所有者のUID
end
</code></pre>

<p>ファイル操作系。</p>

<pre><code class="language-ruby"># ファイル名変更、ファイル移動
File.rename 'hoge', 'fuga'
File.rename 'hoge', 'dir/hoge'

# ファイル削除
File.unlink 'hoge'

# シンボリックリンク作成
File.symlink 'target', 'link'

# ハードリンク作成
File.link 'target', 'link'

# ファイルモード変更
File.chmod 0600, 'filename'

# 所有者、グループの変更
File.chown 100, 100, 'filename'
</code></pre>

<p>ファイルパスに関するもろもろ。</p>

<pre><code class="language-ruby"># ファイルのあるディレクトリパスの取得
File.dirname(&quot;etc/sample.txt&quot;) # =&gt; &quot;/etc&quot;

# 第一引数に与えたファイルパスに対する、ファイル名の取得。第二引数でsuffix指定。
File.basename(&quot;etc/sample.txt&quot;) # =&gt; &quot;sample.txt&quot;
File.basename(&quot;etc/sample.txt&quot;, &quot;.txt&quot;) # =&gt; &quot;sample&quot;

# 拡張子の取得
File.extname(&quot;etc/sample.txt&quot;) # =&gt; &quot;.txt&quot;

# ファイルパスの連結（引数は可変長）
File.join(&quot;/usr/local&quot;, &quot;bin/ruby&quot;) # =&gt; &quot;/usr/local/bin/ruby&quot;

# ファイルパスからdirnameとbasenameを取得し配列生成
File.split(&quot;/usr/local/bin/ruby&quot;) # =&gt; [&quot;/usr/local/bin&quot;, &quot;ruby&quot;]

# 絶対パスの展開
File.expand_path(&quot;~&quot;) # =&gt; &quot;/home/chroju&quot;
File.expand_path(&quot;filename&quot;, &quot;~&quot;) # =&gt; &quot;/home/chroju/filename&quot;

# absolute_pathでは~を展開しない
File.absolute_path(&quot;~&quot;) # =&gt; &quot;/home/chroju/~&quot;
</code></pre>

<p>Dirクラスも触れたいのだが、長くなるので一旦ここまで。</p>

                </section>
            </article>
            <footer id="post-meta" class="clearfix">
                
                        <img class="avatar" src="https://chroju.github.io/images/avatar.png">
                        <div>
                            <span class="dark">the world as code</span>
                            <span></span>
                        </div>
                    
                <section id="sharing">
                    <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fchroju.github.io%2fblog%2f2015%2f04%2f10%2fstudy-ruby-file-i-o%2f - Ruby%e5%9f%ba%e7%a4%8e%e5%be%a9%e7%bf%92%288%29%20File%e3%82%af%e3%83%a9%e3%82%b9 "><span class="icon-twitter"> Tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

                </section>
            </footer>

            

            <ul id="post-list" class="archive readmore">
    <h3>Read more</h3>
    
    
        
        <li>
            <a href="https://chroju.github.io/blog/2017/02/07/try_on_serverless_architecture/">サーバーレスっぽいインフラをどう管理していくか<aside class="dates">Feb 7</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://chroju.github.io/blog/2017/02/05/barocco_review/">Baroccoで分割キーボードデビューした<aside class="dates">Feb 5</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://chroju.github.io/blog/2016/12/28/looking_back_2016/">2016年総括 - 技術者って何なのかやっと理解した<aside class="dates">Dec 28</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://chroju.github.io/blog/2016/12/27/esa_io_personal_use/">esa.ioを個人利用している話<aside class="dates">Dec 27</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://chroju.github.io/blog/2016/12/17/engineering_problem_solving/">エンジニアの問題解決力とは何か<aside class="dates">Dec 17</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://chroju.github.io/blog/2016/10/25/what_is_ops/">多義化するOpsのミッションについて<aside class="dates">Oct 25</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://chroju.github.io/blog/2016/10/03/serverless-conf-tokyo/">ServerlessConfとエンジニアの職掌に関して<aside class="dates">Oct 3</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://chroju.github.io/blog/2016/08/01/soft_skills_and_our_productivity/">『SOFT SKILLS』と「やっていく気持ち」<aside class="dates">Aug 1</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://chroju.github.io/blog/2016/07/02/yapc8oji_2016/">YAPC経験ないけどパチモンの方に行った<aside class="dates">Jul 2</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://chroju.github.io/blog/2016/06/05/aws_summit_ansible_meetup_2016/">Serverlessの時代とas code<aside class="dates">Jun 5</aside></a>
        </li>
        
   
</ul>
            <footer id="footer">
    
        
<div id="social">
    
    <a class="symbol" href="https://github.com/chroju">
        circlegithubalt
    </a>
    
    <a class="symbol" href="https://twitter.com/chroju">
        circletwitterbird
    </a>
    
</div>

    
    <p class="small">
    
        written by chroju
    
    </p>
</footer>

        </section>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://chroju.github.io/js/main.js"></script>
<script src="https://chroju.github.io/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


    </body>
</html>
